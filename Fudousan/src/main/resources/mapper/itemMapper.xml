<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.real.fudousan.item.dao.ItemMapper">
	<resultMap type="item" id="itemResultMap">
		<id property="itemId" column="item_id"/>
		<result property="itemName" column="item_name"/>
		<result property="text" column="text"/>
		<result property="fileDirectory" column="file_directory"/>
		<result property="modelFileName" column="model_file_name"/>
		<result property="itemScale" column="item_scale"/>
		<association property="itemType" column="item_type_id" javaType="com.real.fudousan.item.vo.ItemType" resultMap="itemTypeResultMap"/>
		<collection property="refSiteSet" column="id" ofType="com.real.fudousan.item.vo.RefSite" resultMap="refSiteResultMap"/>
	</resultMap>

	<resultMap type="itemtype" id="itemTypeResultMap">
		<id property="itemTypeId" column="item_type_id"/>
		<result property="itemTypeName" column="item_type_name"/>
	</resultMap>
	
	<resultMap type="refsite" id="refSiteResultMap">
		<id property="id" column="id"/>
		<result property="url" column="url"/>
		<result property="creDate" column="cre_date"/>
		<result property="text" column="ref_site_text"/>
	</resultMap>
	
	<sql id="SELECT_ITEM_SQL">
	
		SELECT
			item.item_id item_id
			, item_name
			, item.text text
			, file_directory
			, model_file_name
			, item.item_type_id item_type_id
			-- item_type
			, item_type_name
			-- ref_site
			, id
			, url
			, cre_date
			, ref_site.text ref_site_text
			, item_scale
		FROM
			item
		JOIN
			item_type
		ON
			item.item_type_id = item_type.item_type_id
		LEFT OUTER JOIN
			ref_site
		ON
			item.item_id = ref_site.item_id
	
	</sql>

	<select id="selectAll" resultMap="itemResultMap">
		<include refid="SELECT_ITEM_SQL"></include>
	</select>
	
	<select id="selectById" parameterType="int" resultMap="itemResultMap">
		<include refid="SELECT_ITEM_SQL"></include>
		WHERE
			item.item_id = #{0}
	</select>
	
	<select id="selectByName" parameterType="String" resultMap="itemResultMap">
		<include refid="SELECT_ITEM_SQL"></include>
		WHERE
			item.item_name LIKE '%'||#{0}||'%'
	</select>

	<insert id="insert" parameterType="item">
		INSERT INTO
			item
			(
				item_type_id,
				item_name,
				text,
				model_file_name
			)
		VALUES
			(
				#{itemType.itemTypeId},
				#{itemName},
				#{text},
				#{modelFileName}
			)
		<selectKey resultType="int" keyProperty="itemId" order="AFTER">
			SELECT seq_item_id.currval FROM dual
		</selectKey>
	</insert>
	
	<insert id="insertRefSite" parameterType="item">
		<foreach collection="refSiteSet" item="site" index="index"  open="INSERT ALL " separator=" " close="SELECT * FROM DUAL" > 
		INTO
			ref_site
			(
				url
				, text
				, item_id
			)
		VALUES
			(
				#{site.url}
				<if test="site.text == null">
					, ''
				</if>
				<if test="site.text != null">
					, #{site.text}
				</if>
				, #{site.itemId}
			)
		</foreach>
	</insert>
	
	<update id="update" parameterType="item">
		UPDATE
			item
		SET
			item_name = #{itemName}
			, item_type_id = #{itemType.itemTypeId}
			, model_file_name = #{modelFileName}
			, text = #{text}
		WHERE item_id = #{itemId}
	</update>
	
	<delete id="deleteAllRefSite" parameterType="int">
		DELETE FROM ref_site
		WHERE item_id = #{0}
	</delete>
	
	<delete id="delete" parameterType="int">
		DELETE FROM item
		WHERE item_id = #{0}
	</delete>
</mapper>
